<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#111111">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="manifest" href="manifest.json">
  <title>Car Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #111;
      color: #e0e0e0;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Calendar - Left 65% */
    .calendar-section {
      width: 65%;
      padding: 20px 24px;
      overflow-y: auto;
      border-right: 1px solid #2a2a2a;
    }

    .calendar-section::-webkit-scrollbar { width: 4px; }
    .calendar-section::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #888;
      margin-bottom: 12px;
    }

    .today-header {
      color: #5b9bd5;
    }

    .upcoming-header {
      color: #888;
      margin-top: 24px;
    }

    .event {
      display: flex;
      align-items: baseline;
      padding: 8px 0;
      border-bottom: 1px solid #1e1e1e;
    }

    .event-time {
      color: #5b9bd5;
      font-size: 15px;
      font-weight: 500;
      min-width: 90px;
      flex-shrink: 0;
    }

    .event-date {
      color: #7a7a7a;
      font-size: 14px;
      font-weight: 500;
      min-width: 110px;
      flex-shrink: 0;
    }

    .event-title {
      font-size: 16px;
      color: #d0d0d0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      min-width: 0;
    }

    .no-events {
      color: #555;
      font-style: italic;
      padding: 12px 0;
      font-size: 15px;
    }

    /* Weather - Right 35% */
    .weather-section {
      width: 35%;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .current-weather {
      text-align: center;
      padding-bottom: 20px;
      border-bottom: 1px solid #2a2a2a;
      margin-bottom: 16px;
    }

    .weather-icon {
      font-size: 48px;
      line-height: 1.2;
    }

    .current-temp {
      font-size: 52px;
      font-weight: 300;
      color: #fff;
      line-height: 1.1;
    }

    .current-conditions {
      font-size: 16px;
      color: #999;
      margin-top: 4px;
    }

    .forecast {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .forecast-day {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 4px;
      border-bottom: 1px solid #1e1e1e;
    }

    .forecast-name {
      font-size: 14px;
      color: #aaa;
      width: 50px;
    }

    .forecast-icon {
      font-size: 22px;
      width: 36px;
      text-align: center;
    }

    .forecast-high {
      font-size: 18px;
      font-weight: 500;
      color: #fff;
      width: 50px;
      text-align: right;
    }

    /* Bottom Bar */
    .bottom-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 24px;
      background: #0a0a0a;
      border-top: 1px solid #2a2a2a;
      flex-shrink: 0;
    }

    .clock {
      font-size: 28px;
      font-weight: 300;
      color: #fff;
      font-variant-numeric: tabular-nums;
    }

    .last-updated {
      font-size: 12px;
      color: #555;
    }

    .offline-badge {
      display: none;
      font-size: 11px;
      color: #e67e22;
      background: #2a1f0a;
      padding: 3px 10px;
      border-radius: 10px;
    }

    .offline-badge.visible { display: inline-block; }
  </style>
</head>
<body>

  <div class="main">
    <div class="calendar-section">
      <div class="section-title today-header">Today's Events</div>
      <div id="today-events"><div class="no-events">Loading...</div></div>

      <div class="section-title upcoming-header">Upcoming (7 Days)</div>
      <div id="upcoming-events"><div class="no-events">Loading...</div></div>
    </div>

    <div class="weather-section">
      <div class="current-weather">
        <div class="section-title">Current Weather</div>
        <div class="weather-icon" id="current-icon">--</div>
        <div class="current-temp" id="current-temp">--¬∞F</div>
        <div class="current-conditions" id="current-conditions">Loading...</div>
      </div>

      <div class="section-title" style="margin-bottom:10px;">5-Day Forecast</div>
      <div class="forecast" id="forecast">
        <div class="no-events">Loading...</div>
      </div>
    </div>
  </div>

  <div class="bottom-bar">
    <div class="clock" id="clock">--:--</div>
    <span class="offline-badge" id="offline-badge">OFFLINE</span>
    <div class="last-updated" id="last-updated">Last updated: --</div>
  </div>

  <script>
    // --- Config ---
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyqnVd_mEFRFwALoGodEqX4wbLLGTLZGrooUNpk-s4GORBxRzxcu7XtIw1DT0tDijR0/exec';
    const LAT = 37.7742;
    const LON = -87.1114;
    const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes

    // --- Weather code to emoji/description mapping ---
    const WMO_CODES = {
      0: ['‚òÄÔ∏è', 'Clear sky'],
      1: ['üå§Ô∏è', 'Mainly clear'],
      2: ['‚õÖ', 'Partly cloudy'],
      3: ['‚òÅÔ∏è', 'Overcast'],
      45: ['üå´Ô∏è', 'Fog'],
      48: ['üå´Ô∏è', 'Rime fog'],
      51: ['üå¶Ô∏è', 'Light drizzle'],
      53: ['üå¶Ô∏è', 'Drizzle'],
      55: ['üåßÔ∏è', 'Dense drizzle'],
      61: ['üåßÔ∏è', 'Light rain'],
      63: ['üåßÔ∏è', 'Rain'],
      65: ['üåßÔ∏è', 'Heavy rain'],
      66: ['üå®Ô∏è', 'Freezing rain'],
      67: ['üå®Ô∏è', 'Heavy freezing rain'],
      71: ['üå®Ô∏è', 'Light snow'],
      73: ['üå®Ô∏è', 'Snow'],
      75: ['‚ùÑÔ∏è', 'Heavy snow'],
      77: ['‚ùÑÔ∏è', 'Snow grains'],
      80: ['üå¶Ô∏è', 'Light showers'],
      81: ['üåßÔ∏è', 'Showers'],
      82: ['üåßÔ∏è', 'Violent showers'],
      85: ['üå®Ô∏è', 'Light snow showers'],
      86: ['üå®Ô∏è', 'Snow showers'],
      95: ['‚õàÔ∏è', 'Thunderstorm'],
      96: ['‚õàÔ∏è', 'Thunderstorm w/ hail'],
      99: ['‚õàÔ∏è', 'Thunderstorm w/ heavy hail'],
    };

    function getWeatherInfo(code) {
      return WMO_CODES[code] || ['‚ùì', 'Unknown'];
    }

    function esc(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    // --- Local Storage Cache ---
    function cacheSet(key, data) {
      localStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() }));
    }

    function cacheGet(key) {
      try {
        return JSON.parse(localStorage.getItem(key));
      } catch { return null; }
    }

    // --- Clock ---
    function updateClock() {
      const now = new Date();
      const h = now.getHours();
      const m = String(now.getMinutes()).padStart(2, '0');
      const ampm = h >= 12 ? 'PM' : 'AM';
      const h12 = h % 12 || 12;
      document.getElementById('clock').textContent = `${h12}:${m} ${ampm}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // --- Online/Offline ---
    function updateOnlineStatus() {
      document.getElementById('offline-badge').classList.toggle('visible', !navigator.onLine);
    }
    window.addEventListener('online', () => { updateOnlineStatus(); refreshAll(); });
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();

    // --- Last Updated ---
    function setLastUpdated() {
      const now = new Date();
      const str = now.toLocaleString('en-US', {
        hour: 'numeric', minute: '2-digit', hour12: true,
        month: 'short', day: 'numeric'
      });
      document.getElementById('last-updated').textContent = `Last updated: ${str}`;
      localStorage.setItem('lastUpdated', str);
    }

    function loadLastUpdated() {
      const saved = localStorage.getItem('lastUpdated');
      if (saved) {
        document.getElementById('last-updated').textContent = `Last updated: ${saved}`;
      }
    }

    // --- Calendar ---
    async function fetchCalendarEvents() {
      try {
        const res = await fetch(APPS_SCRIPT_URL);
        if (!res.ok) throw new Error('Calendar API error');
        const data = await res.json();
        cacheSet('calendarEvents', data.items || []);
        return data.items || [];
      } catch (e) {
        console.warn('Calendar fetch failed, using cache:', e);
        const cached = cacheGet('calendarEvents');
        return cached ? cached.data : [];
      }
    }

    function renderCalendar(events) {
      const now = new Date();
      const todayStr = now.toISOString().slice(0, 10);
      const todayEl = document.getElementById('today-events');
      const upcomingEl = document.getElementById('upcoming-events');

      const todayEvents = [];
      const upcomingEvents = [];

      events.forEach(ev => {
        const start = ev.start.dateTime || ev.start.date;
        const eventDate = start.slice(0, 10);
        const isAllDay = !ev.start.dateTime;

        if (eventDate === todayStr) {
          todayEvents.push(ev);
        } else if (eventDate > todayStr) {
          upcomingEvents.push(ev);
        }
      });

      if (todayEvents.length === 0) {
        todayEl.innerHTML = '<div class="no-events">No events today</div>';
      } else {
        todayEl.innerHTML = todayEvents.map(ev => {
          const isAllDay = !ev.start.dateTime;
          let timeStr = 'All day';
          if (!isAllDay) {
            const d = new Date(ev.start.dateTime);
            const h = d.getHours() % 12 || 12;
            const m = String(d.getMinutes()).padStart(2, '0');
            const ap = d.getHours() >= 12 ? 'PM' : 'AM';
            timeStr = `${h}:${m} ${ap}`;
          }
          return `<div class="event"><span class="event-time">${timeStr}</span><span class="event-title">${esc(ev.summary || '(No title)')}</span></div>`;
        }).join('');
      }

      if (upcomingEvents.length === 0) {
        upcomingEl.innerHTML = '<div class="no-events">No upcoming events</div>';
      } else {
        upcomingEl.innerHTML = upcomingEvents.map(ev => {
          const start = ev.start.dateTime || ev.start.date;
          const d = new Date(start);
          const dateStr = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
          return `<div class="event"><span class="event-date">${dateStr}</span><span class="event-title">${esc(ev.summary || '(No title)')}</span></div>`;
        }).join('');
      }
    }

    // --- Weather ---
    async function fetchWeather() {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}` +
        `&current=temperature_2m,weather_code&daily=temperature_2m_max,weather_code` +
        `&temperature_unit=fahrenheit&timezone=America%2FChicago&forecast_days=6`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Weather API error');
        const data = await res.json();
        cacheSet('weather', data);
        return data;
      } catch (e) {
        console.warn('Weather fetch failed, using cache:', e);
        const cached = cacheGet('weather');
        return cached ? cached.data : null;
      }
    }

    function renderWeather(data) {
      if (!data) return;

      const code = data.current.weather_code;
      const [icon, desc] = getWeatherInfo(code);
      const temp = Math.round(data.current.temperature_2m);

      document.getElementById('current-icon').textContent = icon;
      document.getElementById('current-temp').textContent = `${temp}¬∞F`;
      document.getElementById('current-conditions').textContent = desc;

      const forecastEl = document.getElementById('forecast');
      const days = data.daily;
      let html = '';

      // Start from today (index 0), show 5 days
      for (let i = 0; i < 5 && i < days.time.length; i++) {
        const d = new Date(days.time[i] + 'T12:00:00');
        const name = d.toLocaleDateString('en-US', { weekday: 'short' });
        const [fIcon] = getWeatherInfo(days.weather_code[i]);
        const high = Math.round(days.temperature_2m_max[i]);
        html += `<div class="forecast-day">
          <span class="forecast-name">${name}</span>
          <span class="forecast-icon">${fIcon}</span>
          <span class="forecast-high">${high}¬∞F</span>
        </div>`;
      }
      forecastEl.innerHTML = html;
    }

    // --- Refresh All ---
    async function refreshAll() {
      const [events, weather] = await Promise.all([
        fetchCalendarEvents(),
        fetchWeather()
      ]);
      renderCalendar(events);
      renderWeather(weather);
      setLastUpdated();
    }

    // --- Init ---
    (function init() {
      loadLastUpdated();

      // Load cached data immediately
      const cachedCal = cacheGet('calendarEvents');
      if (cachedCal) renderCalendar(cachedCal.data);

      const cachedWeather = cacheGet('weather');
      if (cachedWeather) renderWeather(cachedWeather.data);

      // Then refresh from network
      refreshAll();

      // Auto-refresh
      setInterval(() => {
        if (navigator.onLine) refreshAll();
      }, REFRESH_INTERVAL);
    })();

    // --- Register Service Worker ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</body>
</html>
